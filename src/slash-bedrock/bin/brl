#!/bedrock/libexec/busybox sh
#
# brl
#
#      This program is free software; you can redistribute it and/or
#      modify it under the terms of the GNU General Public License
#      version 2 as published by the Free Software Foundation.
#
# Copyright (c) 2012-2019 Daniel Thau <danthau@bedrocklinux.org>
#
# This program manages and provides information about a Bedrock Linux install
# and its subsystems.

. /bedrock/share/common-code

print_help() {
	# Parse and sort help information from backend files
	help_msg="$(cat <<EOF | sort
$(find /bedrock/share/brl/backends/ -mindepth 1 -maxdepth 1 -type f -exec awk -F'::' '/brl help:/{OFS = FS; print $(NF-2), $(NF-1),"  "$NF}' {} \;)
EOF
	)"

	# Expand color information
	help_msg="$(eval "cat <<EOF
${help_msg}
EOF")"

	# Divide help information into designated section
	s1="$(echo "${help_msg}" | awk -F'::' '/^1/{print $3}')"
	s2="$(echo "${help_msg}" | awk -F'::' '/^2/{print $3}')"
	s3="$(echo "${help_msg}" | awk -F'::' '/^3/{print $3}')"
	s4="$(echo "${help_msg}" | awk -F'::' '/^4/{print $3}')"
	s5="$(echo "${help_msg}" | awk -F'::' '/^5/{print $3}')"
	s6="$(echo "${help_msg}" | awk -F'::' '/^6/{print $3}')"

	printf "Usage: ${color_cmd}brl ${color_sub}<command> [arguments]${color_norm}

${color_bedrock}Bedrock Linux${color_norm} system management and introspection.

Common commands:
  ${color_cmd}strat     ${color_norm}Run specified ${color_term}stratum${color_norm}'s executable
  ${color_cmd}          ${color_norm}Note: ${color_cmd}\`strat\`${color_norm} is available without the ${color_cmd}\`brl\`${color_norm} prefix
${s1}

${color_term}Strata${color_norm} management commands:
${s2}

${color_term}Strata${color_norm} status management commands:
${s3}

${color_term}Strata${color_norm} visibility management commands:
${s4}

${color_term}Alias${color_norm} management commands:
${s5}

Miscellaneous commands:
${s6}

See ${color_cmd}\`brl ${color_sub}<command>${color_cmd} --help\`${color_norm} for further details per command.
"
}

case "${1:-}" in
"-h" | "--help" | "help" | "")
	print_help
	exit_success
	;;
*)
	backend="/bedrock/share/brl/backends/brl-${1}"
	if [ -f "${backend}" ]; then
		shift
		exec "${backend}" "${@}"
		abort "Unable to execute \`${backend}\`"
	else
		abort "Unrecognized brl subcommand.  See \`${0} --help\`"
	fi
	;;
esac

exit_success
